var booksellerToIdMap={};function PrintCountTable(a,b){var c=window.open();c.document.writeln('<!DOCTYPE html><html><head><style type="text/css" media="print">@page { size: landscape; }</style></head><body>');c.document.writeln("<div style='margin: auto auto 30px; width:90%; font-size: 30px; text-align: center;'>"+b+"</div>");c.document.writeln(a.outerHTML);c.document.writeln('<script>document.getElementById("'+a.getAttribute("id")+'").style.fontSize = "12pt"<\/script>');c.document.writeln("<script>window.print()<\/script>");c.document.writeln("</body></html>");c.document.close()}function PrintDynamicTable(b,c,a){var d=window.open();d.document.writeln('<!DOCTYPE html><html><head><style type="text/css" media="print">@page { size: landscape; }</style></head><body>');d.document.writeln("<div style='margin: auto auto 30px; width:90%; font-size: 30px; text-align: center;'>"+c+"</div>");d.document.writeln(GetDynamicTableHtml(b,a));d.document.writeln('<script>document.getElementById("'+b.id+'").style.fontSize = "12pt"<\/script>');d.document.writeln("<script>window.print()<\/script>");d.document.writeln("</body></html>");d.document.close()}function GetDynamicTableHtml(b,a){var c="<table cellspacing='0' border='1px;' style='border-collapse:collapse;'><thead>";var e="";var d="";$("#"+b.id+" thead tr").each(function(f,g){d="";$(g).children("th").each(function(j,h){if(j!==a){d+="<th>"+$(h).text()+"</th>"}});e+="<tr>"+d+"</tr>"});c+=e+"</thead><tbody>";e="";$("#"+b.id+" tr").each(function(f,g){d="";$(g).children("td").each(function(j,h){if(j!==a){if($(h).children("input").val()===undefined){d+="<td>"+$(h).text()+"</td>"}else{d+="<td>"+$(h).children("input").val()+"</td>"}}});e+="<tr>"+d+"</tr>"});c+=e+"</tbody></table>";return c}function PreViewTable(a,b){console.log("PreViewTable");var c=window.open();c.document.writeln('<!DOCTYPE html><html><head><style type="text/css" media="print">@page { size: landscape; }</style></head><body>');c.document.writeln("<div style='margin: auto auto 30px; width:90%; font-size: 30px; text-align: center;'>"+b+"</div>");c.document.writeln(a.outerHTML);c.document.writeln('<script>document.getElementById("'+a.getAttribute("id")+'").style.fontSize = "12pt"<\/script>');c.document.writeln("</body></html>");c.document.close()}function CreateBookSeller(){console.log("CreateBookSeller");var c=window.localStorage.et;var b=window.localStorage.backServerUrl;var a=prompt("请输入供应商名称:");if(a!=""&&a!=null){var d={name:a,description:""};$.ajax({type:"PUT",url:b+"api/vendor/members",dataType:"json",headers:{"Content-Type":"application/json",Authorization:c},data:JSON.stringify(d),success:function(e){GetBookSeller();alert("供应商添加成功!")},error:function(e,h,g){var f="CreateBookSeller";alert(f+" 请求产生错误!\nstatus = "+e.status+"\nstatusText = "+e.statusText+"\nreadyState = "+e.readyState+"\nresponseText = "+e.responseText)}})}}function GetBookSeller(){console.log("GetBookSeller");var b=window.localStorage.et;var a=window.localStorage.backServerUrl;$.ajax({type:"GET",url:a+"api/vendor/members?limit=-1&offset=",dataType:"json",headers:{"Content-Type":"application/json",Authorization:b},success:function(c){console.log(c);$("#supplier").empty();c.content.forEach(function(d){$("#supplier").append("<option text='"+d.name+"' value='"+d.id+"'>"+d.name+"</option>");booksellerToIdMap[d.name]=d.id})},error:function(c,f,e){var d="GetBookSeller";alert(d+" 请求产生错误!\nstatus = "+c.status+"\nstatusText = "+c.statusText+"\nreadyState = "+c.readyState+"\nresponseText = "+c.responseText)}})}function DeleteBookSeller(){console.log("DeleteBookSeller");var d=window.localStorage.et;var b=window.localStorage.backServerUrl;var a=$("#supplier").find("option:selected").text();if(confirm("确定要删除当前的供应商 "+a+" 吗?")){var c=$("#supplier").val();$.ajax({type:"DELETE",url:b+"api/vendor/members/"+c,dataType:"json",headers:{"Content-Type":"application/json",Authorization:d},success:function(e){GetBookSeller();alert("删除供应商成功!")},error:function(e,h,g){var f="DeleteBookSeller";alert(f+" 请求产生错误!\nstatus = "+e.status+"\nstatusText = "+e.statusText+"\nreadyState = "+e.readyState+"\nresponseText = "+e.responseText)}})}}function SaveDocPreorder(e){console.log("SaveDocPreorder");var i=window.localStorage.et;var h=window.localStorage.backServerUrl;if($(e).val()==="新建订单"){$("#pubutton").val("预订");mytable.reset();return}if($("#edittable").children("table").children("tbody").children("tr").children("td").eq(7).children("input").val()!==""){alert("订单不可重复提交!");return}if(confirm("确定提交预订单?")){var d=document.getElementById("edittable");var g=generateArrayFromEditTable(d);console.log(g);if(g[0].length<2||g[0][1][0]===null){alert("表格没有数据!");return}var a=$("#preorderdate").datebox("getValue");var f=[];g[0].forEach(function(k,j){if(j>0){f.push({title:k[0],author:k[1],publisher:k[2],isbn:k[3],price:k[4].toString(),quantity:k[5].toString(),total:k[6].toString(),description:k[8]})}});console.log(f);var c=parseInt($("#supplier").val());var b={items:f,vendor_id:c,order_date:a};$.ajax({type:"PUT",url:h+"api/vendor/orders",dataType:"json",headers:{"Content-Type":"application/json",Authorization:i},data:JSON.stringify(b),success:function(j){console.log(j);$("#edittable tr").each(function(k,l){$(l).children("td").eq(7).children("input").val(j.created[k-1])});$("#edittable").children("table").children("thead").children("tr").children("th").eq(9).hide();$("#edittable").children("table").children("tbody").children("tr").each(function(k,l){$(l).children("td").eq(9).hide()});$("#pubutton").val("新建订单");alert("添加文献预定单成功!")},error:function(j,m,l){var k="SaveDocPreorder";alert(k+" 请求产生错误!\nstatus = "+j.status+"\nstatusText = "+j.statusText+"\nreadyState = "+j.readyState+"\nresponseText = "+j.responseText)}})}}function SearchPreorder(){console.log("SearchPreorder");var d=window.localStorage.et;var a=window.localStorage.backServerUrl;var c=$("#supplier").val();var b=$("#isbnfs").val();$.ajax({type:"GET",url:a+"api/vendor/orders?limit=-1&offset=&start=1970-01-01T00:00:00.001%2B08:00&end=2030-12-31T23:59:59.999%2B08:00&is_arrived=false&vendor_id="+c+"&isbn="+b,dataType:"json",headers:{"Content-Type":"application/json",Authorization:d},success:function(f){console.log(f);var g=[];var e=[];f.content.forEach(function(h){e=[];e.push(h.title);e.push(h.author);e.push(h.publisher);e.push(h.isbn);e.push(h.price);e.push(h.quantity);e.push(h.total);e.push(h.vendor);e.push(h.order_date.substring(0,10));e.push("");e.push(h.actual_price);e.push(h.actual_quantity);e.push(h.id);e.push(h.description);g.push(e)});console.log(g);myordertable.loadData(g);$("#edittable input").blur(function(){var i=$("#bookindate").datebox("getValue");var h=$(this).parent().parent().children("td").eq(11).children("input").val();if((h===""||h==="0")){$(this).parent().parent().children("td").eq(9).children("input").val("")}else{if($(this).parent().parent().children("td").eq(9).children("input").val()===""){$(this).parent().parent().children("td").eq(9).children("input").val(i)}}})},error:function(e,h,g){var f="SearchPreorder";alert(f+" 请求产生错误!\nstatus = "+e.status+"\nstatusText = "+e.statusText+"\nreadyState = "+e.readyState+"\nresponseText = "+e.responseText)}})}function SearchPreorderAll(){console.log("SearchPreorderAll");var f=window.localStorage.et;var b=window.localStorage.backServerUrl;var c=$("#startdate").datebox("getValue");var a=$("#enddate").datebox("getValue");var d=$("#supplier").val();var e=$("#ordertype").val();$.ajax({type:"GET",url:b+"api/vendor/orders?limit=-1&offset=&start=2000-01-01T00:00:00.001%2B08:00&end=2030-12-31T23:59:59.999%2B08:00&is_arrived="+e+"&vendor_id="+d+"&order_date="+c+","+a,dataType:"json",headers:{"Content-Type":"application/json",Authorization:f},beforeSend:function(){$("#searchbutton").addClass("breath_light")},success:function(h){var g="";h.content.forEach(function(i){g+="<tr><td>"+i.id+"</td><td>"+i.title+"</td><td>"+i.author+"</td><td>"+i.publisher+"</td><td>"+i.isbn+"</td><td style='text-align: right'>"+i.price+"</td><td style='text-align: right'>"+i.quantity+"</td><td style='text-align: right'>"+i.total+"</td><td>"+i.vendor+"</td><td>"+i.order_date.substring(0,10)+"</td><td>"+i.arrive_at.substring(0,10)+"</td><td style='text-align: right'>"+i.actual_price+"</td><td style='text-align: right'>"+i.actual_quantity+"</td><td style='text-align: right'>"+i.actual_total+"</td><td>"+i.description+"</td><td>"+i.user+"</td><td><input type='button' value='删除' onclick='DeleteBookOrder("+i.id+",this)'></td></tr>"});$("#edittable tbody").html(g)},complete:function(){$("#searchbutton").removeClass("breath_light")},error:function(g,j,i){$("#searchbutton").removeClass("breath_light");var h="SearchPreorderAll";alert(h+" 请求产生错误!\nstatus = "+g.status+"\nstatusText = "+g.statusText+"\nreadyState = "+g.readyState+"\nresponseText = "+g.responseText)}})}function DeleteBookOrder(d,b){console.log("DeleteBookOrder");var c=window.localStorage.et;var a=window.localStorage.backServerUrl;if(confirm("确定删除订单号为 "+d+" 订单吗?")){$.ajax({type:"DELETE",url:a+"api/vendor/orders",dataType:"json",headers:{"Content-Type":"application/json",Authorization:c},data:JSON.stringify({order_ids:[d]}),success:function(e){$(b).parent().parent().html("");alert("订单删除成功!")},error:function(e,h,g){var f="DeleteBookOrder";alert(f+" 请求产生错误!\nstatus = "+e.status+"\nstatusText = "+e.statusText+"\nreadyState = "+e.readyState+"\nresponseText = "+e.responseText)}})}}function SaveDocSigned(){console.log("SaveDocSigned");var d=window.localStorage.et;var b=window.localStorage.backServerUrl;if(confirm("确定保存?")){var e=document.getElementById("edittable");var a=generateArrayFromEditTableForSigned(e);if(a[0].length<2){alert("表格没有数据!");return}console.log("oo[0]");console.log(a[0]);var c=[];a[0].forEach(function(h,g){if(g>0){c.push({id:h[12],title:h[0],author:h[1],publisher:h[2],isbn:h[3],price:h[4],quantity:h[5],total:h[6],order_date:h[8],arrive_at:h[9],actual_price:h[10],actual_quantity:h[11],actual_total:h[10]*h[11],description:h[13],vendor_id:parseInt(booksellerToIdMap[h[7]])})}});console.log(c);var f={items:c};$.ajax({type:"PATCH",url:b+"api/vendor/orders",dataType:"json",headers:{"Content-Type":"application/json",Authorization:d},data:JSON.stringify(f),success:function(g){console.log(g);alert("文献签到成功!")},error:function(g,j,i){var h="SaveDocSigned";alert(h+" 请求产生错误!\nstatus = "+g.status+"\nstatusText = "+g.statusText+"\nreadyState = "+g.readyState+"\nresponseText = "+g.responseText)}})}}function generateArrayFromEditTableForSigned(m){var g=[];var o=m.querySelectorAll("tr");var b=[];for(var h=0;h<o.length;++h){var i=[];var n=o[h];var d;if(h===0){d=n.querySelectorAll("th")}else{d=n.querySelectorAll("td")}for(var a=0;a<d.length;++a){var j=d[a];var c=j.getAttribute("colspan");var f=j.getAttribute("rowspan");var l;if(h===0){l=j.innerText}else{l=j.querySelector("input").value}if(l!==""&&l==+l){l=+l}b.forEach(function(k){if(h>=k.s.r&&h<=k.e.r&&i.length>=k.s.c&&i.length<=k.e.c){for(var p=0;p<=k.e.c-k.s.c;++p){i.push(null)}}});if(f||c){f=f||1;c=c||1;b.push({s:{r:h,c:i.length},e:{r:h+f-1,c:i.length+c-1}})}i.push(l!==""?l:null);if(c){for(var e=0;e<c-1;++e){i.push(null)}}}g.push(i)}return[g,b]}function testnumber(c){if(!(/^((?!0)\d+(\.\d{1,2})?)$/g.test(c.value))){alert("请输入正确的数据格式！(整数或小数)");c.value=c.value.replace(/[^.\d]/g,"")}var b=$(c).parent().parent().children("td").eq(4).children("input").val();var a=$(c).parent().parent().children("td").eq(5).children("input").val();$(c).parent().parent().children("td").eq(6).children("input").val(b*a)};